<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>动态膨胀心形烟花</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            background: black;
            overflow: hidden;
        }

        canvas {
            display: block;
        }
    </style>
</head>

<body>
    <canvas id="canvas"></canvas>
     <canvas class="fireworks"
        style="position:fixed;left:0;top:0;z-index:99999999;pointer-events:none;max-height: 100%;overflow: hidden;"></canvas>
    <script src="./poiner.js"></script>
    <script>
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const SPREAD_SPEED = 0.5;   // 粒子膨胀速度
        const PARTICLE_LIFE = 300;   // 粒子寿命
        const FADE_SPEED = 0.01;    // 粒子透明度衰减速度

        class Firework {
            constructor(sx, sy, tx, ty, color) {
                this.x = sx;
                this.y = sy;
                this.tx = tx;
                this.ty = ty;
                this.color = color;
                this.speed = 10;
                this.angle = Math.atan2(ty - sy, tx - sx);
                this.distance = Math.hypot(tx - sx, ty - sy);
                this.traveled = 0;
                this.exploded = false;
            }
            update() {
                if (!this.exploded) {
                    let vx = Math.cos(this.angle) * this.speed;
                    let vy = Math.sin(this.angle) * this.speed;
                    this.x += vx;
                    this.y += vy;
                    this.traveled = Math.hypot(this.x, this.y);
                    if (Math.hypot(this.x - this.tx, this.y - this.ty) < this.speed) {
                        this.exploded = true;
                        explodeHeart(this.tx, this.ty, this.color);
                    }
                }
            }
            draw(ctx) {
                if (!this.exploded) {
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, 3, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
        }

        class Particle {
            constructor(x, y, color, dx, dy) {
                this.x = x; this.y = y;
                this.color = color;
                this.dx = dx; this.dy = dy;
                this.alpha = 1;
                this.life = PARTICLE_LIFE;
            }
            update() {
                this.x += this.dx;
                this.y += this.dy;
                this.alpha -= FADE_SPEED;
                this.life--;
            }
            draw(ctx) {
                ctx.save();
                ctx.globalAlpha = this.alpha;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, 2, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }
        }

        let fireworks = [];
        let particles = [];

        // 爆炸成动态心形
        function explodeHeart(x, y, color) {
            let scale = 6;
            for (let t = 0; t < Math.PI * 2; t += 0.05) { // 粒子更密集
                let hx = 16 * Math.pow(Math.sin(t), 3);
                let hy = 13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t);
                let dx = (hx * scale / 20) * SPREAD_SPEED + (Math.random() - 0.5) * 0.1;
                let dy = -(hy * scale / 20) * SPREAD_SPEED + (Math.random() - 0.5) * 0.1;
                particles.push(new Particle(x, y, color, dx, dy));
            }
        }

        // 点击发射
        canvas.addEventListener("click", e => {
            let color = `hsl(${Math.random() * 360},100%,60%)`;
            fireworks.push(new Firework(canvas.width / 2, canvas.height, e.clientX, e.clientY, color));
        });

        // 自动发射
        setInterval(() => {
            let tx = Math.random() * canvas.width;
            let ty = Math.random() * canvas.height / 2;
            let color = `hsl(${Math.random() * 360},100%,60%)`;
            fireworks.push(new Firework(canvas.width / 2, canvas.height, tx, ty, color));
        }, 500);

        function animate() {
            ctx.fillStyle = "rgba(0,0,0,0.2)";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            fireworks.forEach((f, i) => {
                f.update();
                f.draw(ctx);
                if (f.exploded) fireworks.splice(i, 1);
            });

            particles.forEach((p, i) => {
                p.update();
                p.draw(ctx);
                if (p.alpha <= 0 || p.life <= 0) particles.splice(i, 1);
            });

            requestAnimationFrame(animate);
        }
        animate();
    </script>
</body>

</html>